import pandas as pd

def zero_aware_qcut(df, col, q=3, new_col_suffix='_bin'):
    """
    Applies qcut binning to non-zero values and assigns 0 to zero values.
    Handles duplicate bin edges and dynamically adjusts bin labels.
    """
    new_col = col + new_col_suffix
    nonzero_mask = df[col] != 0
    nonzero_values = df.loc[nonzero_mask, col]

    try:
        # Get bin edges with duplicates dropped
        _, bin_edges = pd.qcut(nonzero_values, q=q, retbins=True, duplicates='drop')

        # Adjust labels dynamically based on bin count
        num_bins = len(bin_edges) - 1
        labels = [i for i in range(1, num_bins + 1)]  # Numeric labels for bins

        # Apply qcut to non-zero values
        df.loc[nonzero_mask, new_col] = pd.qcut(
            nonzero_values,
            q=num_bins,
            labels=labels,
            duplicates='drop'
        )
    except ValueError as e:
        print(f"Skipping column '{col}' due to qcut error: {e}")
        df[new_col] = 'error'

    # For zero values, assign a separate bin (e.g., 0 for 'none')
    df.loc[~nonzero_mask, new_col] = 0  # You can set this to a specific number or a flag like 0
    return df




cols_to_bin = ['connected_party_count', 'shared_address_count', 'shared_device_count']

for col in cols_to_bin:
    df = zero_aware_qcut(df, col, q=3, labels=['low', 'medium', 'high'])
